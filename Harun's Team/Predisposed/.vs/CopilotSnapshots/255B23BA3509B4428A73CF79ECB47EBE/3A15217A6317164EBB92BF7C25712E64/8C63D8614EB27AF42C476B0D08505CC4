<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predisposed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            font-size: 2.5rem;
            margin: 20px 0 5px;
            letter-spacing: 3px;
            color: #e94560;
            text-transform: uppercase;
        }
        .subtitle {
            font-size: 0.95rem;
            color: #aaa;
            margin-bottom: 15px;
        }
        #hud {
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        #hud span { color: #e94560; font-weight: bold; }
        #timer-bar-container {
            width: 80%;
            max-width: 900px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-bottom: 18px;
            overflow: hidden;
        }
        #timer-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #e94560, #0f3460);
            border-radius: 3px;
            transition: width 0.25s linear;
        }

        /* Breeds row: two breeds side-by-side */
        #breeds-row {
            display: flex;
            justify-content: center;
            gap: 80px;
            width: 95%;
            max-width: 1100px;
            margin-bottom: 10px;
        }
        .breed-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 0 0 340px;
        }
        .breed-panel img {
            width: 320px;
            height: 427px;
            object-fit: cover;
            border-radius: 14px;
            border: 3px solid #0f3460;
            background: #16213e;
        }
        .breed-panel .breed-name {
            margin-top: 10px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #e94560;
        }

        /* Drop zones below each breed */
        .drop-zone {
            width: 320px;
            min-height: 60px;
            margin-top: 12px;
            border: 2px dashed #0f3460;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 8px;
            transition: border-color 0.2s, background 0.2s;
        }
        .drop-zone.drag-over {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
        }
        .drop-zone-label {
            font-size: 0.8rem;
            color: #555;
            pointer-events: none;
            user-select: none;
        }

        /* Maladies section: centered below breeds */
        #maladies-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 95%;
            max-width: 700px;
            margin-top: 18px;
        }
        #maladies-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
        .malady-card {
            display: flex;
            align-items: center;
            background: #16213e;
            border-radius: 10px;
            padding: 12px 16px;
            gap: 10px;
            cursor: grab;
            user-select: none;
            border: 2px solid transparent;
            transition: opacity 0.3s, transform 0.15s, box-shadow 0.15s;
        }
        .malady-card:active { cursor: grabbing; }
        .malady-card.dragging {
            opacity: 0.5;
            transform: scale(0.97);
        }
        .malady-card.answered {
            cursor: default;
            opacity: 0.55;
        }
        .malady-card.correct-answer { border-color: #4ecca3; }
        .malady-card.wrong-answer { border-color: #e94560; }
        .malady-name {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.3;
        }
        .malady-detail {
            font-size: 0.78rem;
            color: #aaa;
            min-width: 90px;
            text-align: center;
        }
        .points-popup {
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 50px;
            text-align: right;
        }
        .points-popup.correct { color: #4ecca3; }
        .points-popup.wrong { color: #e94560; }

        /* Landed cards in drop zones */
        .malady-landed {
            display: flex;
            align-items: center;
            background: #16213e;
            border-radius: 8px;
            padding: 8px 12px;
            gap: 8px;
            width: 100%;
            font-size: 0.85rem;
            border: 2px solid transparent;
        }
        .malady-landed.correct-answer { border-color: #4ecca3; }
        .malady-landed.wrong-answer { border-color: #e94560; }
        .malady-landed .malady-name { font-size: 0.85rem; }
        .malady-landed .malady-detail { font-size: 0.72rem; min-width: 80px; }
        .malady-landed .points-popup { font-size: 0.8rem; min-width: 40px; }

        /* Drag icon */
        .drag-handle {
            font-size: 1.1rem;
            color: #555;
            flex: 0 0 20px;
        }

        /* Screens */
        .screen { display: none; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }
        #start-screen { margin-top: 80px; text-align: center; }
        #start-screen p { max-width: 500px; color: #aaa; margin: 15px 0 30px; line-height: 1.6; }
        #results-screen { margin-top: 40px; text-align: center; width: 90%; max-width: 700px; }

        .btn {
            padding: 14px 40px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #e94560;
            color: #fff;
            font-weight: bold;
            letter-spacing: 1px;
            transition: background 0.2s;
        }
        .btn:hover { background: #c73652; }

        /* Results */
        .final-score { font-size: 3rem; color: #4ecca3; margin: 15px 0; }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.85rem;
        }
        .results-table th {
            background: #0f3460;
            padding: 10px 8px;
            text-align: left;
        }
        .results-table td {
            padding: 8px;
            border-bottom: 1px solid #333;
            text-align: left;
        }
        .results-table tr.correct-row td:first-child { border-left: 3px solid #4ecca3; }
        .results-table tr.wrong-row td:first-child { border-left: 3px solid #e94560; }
        .result-icon { font-size: 1rem; }

        #next-round-btn {
            margin-top: 18px;
            margin-bottom: 30px;
            padding: 12px 36px;
        }
    </style>
</head>
<body>

<!-- START SCREEN -->
<div id="start-screen" class="screen active">
    <h1>Predisposed</h1>
    <p>Two breeds appear side by side. Five maladies are shown below them. <strong>Drag each malady</strong> to the breed that is more predisposed to it. Score points for correct answers — and earn bonus points for answering quickly!</p>
    <button class="btn" onclick="startGame()">Start Game</button>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen">
    <h1>Predisposed</h1>
    <div id="hud">
        <div>Round: <span id="round-num">1</span> / 5</div>
        <div>Score: <span id="current-score">0</span></div>
        <div>Time: <span id="timer-display">30</span>s</div>
    </div>
    <div id="timer-bar-container"><div id="timer-bar"></div></div>
    <div id="breeds-row">
        <div class="breed-panel" id="left-panel">
            <img id="left-img" src="" alt="Breed A">
            <div class="breed-name" id="left-name"></div>
            <div class="drop-zone" id="drop-left">
                <span class="drop-zone-label">Drop here</span>
            </div>
        </div>
        <div class="breed-panel" id="right-panel">
            <img id="right-img" src="" alt="Breed B">
            <div class="breed-name" id="right-name"></div>
            <div class="drop-zone" id="drop-right">
                <span class="drop-zone-label">Drop here</span>
            </div>
        </div>
    </div>
    <div id="maladies-section">
        <div id="maladies-column"></div>
    </div>
    <button id="next-round-btn" class="btn" style="display:none;" onclick="nextRound()">Next Round</button>
</div>

<!-- RESULTS SCREEN -->
<div id="results-screen" class="screen">
    <h1>Game Over</h1>
    <div class="final-score" id="final-score">0</div>
    <p class="subtitle">Total Points</p>
    <table class="results-table">
        <thead><tr><th></th><th>Round</th><th>Malady</th><th>Your Pick</th><th>Correct</th><th>Points</th></tr></thead>
        <tbody id="results-body"></tbody>
    </table>
    <button class="btn" onclick="startGame()">Play Again</button>
</div>

<script>
    // ── Embedded CSV data ──
    const CSV_RAW = `Breed,Hip Dysplasia,Elbow Dysplasia,Patellar Luxation,Intervertebral Disc Disease (IVDD),Panosteitis,Legg-Calvé-Perthes Disease,Cranial Cruciate Ligament (CCL) Rupture,Spondylosis Deformans,Osteochondritis Dissecans (OCD),Mitral Valve Disease,Dilated Cardiomyopathy (DCM),Subaortic Stenosis,Pulmonic Stenosis,Von Willebrand's Disease,Hemangiosarcoma,Brachycephalic Obstructive Airway Syndrome (BOAS),Tracheal Collapse,Laryngeal Paralysis,Elongated Soft Palate,Stenotic Nares,Atopic Dermatitis,Skin Fold Pyoderma,Sebaceous Adenitis,Color Dilution Alopecia,Ichthyosis,Idiopathic Epilepsy,Degenerative Myelopathy,Syringomyelia,Gastric Dilatation-Volvulus (GDV/Bloat),Exocrine Pancreatic Insufficiency (EPI),Copper Storage Hepatopathy,Portosystemic Shunt,Hyperlipidemia-induced Pancreatitis,Hypoadrenocorticism (Addison's Disease),Hyperadrenocorticism (Cushing's Disease),Osteosarcoma,Mast Cell Tumors,Transitional Cell Carcinoma (TCC),Histiocytic Sarcoma,Lymphoma,MDR1 Drug Sensitivity,Cherry Eye,Progressive Retinal Atrophy (PRA),Entropion,Ectropion,Collie Eye Anomaly,Keratoconjunctivitis Sicca (Dry Eye),Dermoid Sinus,Fanconi Syndrome,Narcolepsy
Great Dane,20%,5%,<1%,5%,4%,<1%,5%,25%,8%,5%,35%,4%,<1%,3%,6%,0%,0%,<1%,0%,0%,10%,<1%,<1%,<1%,2%,2%,15%,1%,35%,<1%,<1%,<1%,<1%,3%,<1%,5%,3%,<1%,<1%,4%,<1%,5%,<1%,15%,15%,<1%,2%,<1%,<1%,<1%
Chihuahua,3%,<1%,30%,2%,<1%,5%,5%,<1%,<1%,20%,<1%,<1%,3%,<1%,<1%,<1%,30%,<1%,<1%,<1%,10%,<1%,<1%,5%,<1%,4%,<1%,5%,<1%,<1%,<1%,2%,2%,<1%,2%,<1%,1%,<1%,<1%,1%,<1%,3%,2%,<1%,<1%,<1%,4%,<1%,<1%,<1%
Komondor,15%,3%,<1%,<1%,2%,<1%,3%,5%,3%,<1%,<1%,<1%,<1%,<1%,2%,0%,0%,<1%,0%,0%,5%,<1%,3%,<1%,<1%,1%,<1%,<1%,25%,<1%,<1%,<1%,<1%,<1%,<1%,1%,<1%,<1%,<1%,1%,<1%,<1%,<1%,20%,5%,<1%,<1%,<1%,<1%,<1%
Chinese Crested Hairless,4%,1%,25%,2%,<1%,10%,4%,<1%,<1%,5%,<1%,<1%,<1%,<1%,<1%,<1%,2%,<1%,<1%,<1%,15%,<1%,<1%,<1%,<1%,4%,<1%,<1%,<1%,<1%,<1%,2%,<1%,<1%,2%,<1%,1%,<1%,<1%,1%,<1%,2%,15%,<1%,<1%,<1%,15%,<1%,<1%,<1%
Greyhound,<1%,<1%,<1%,<1%,2%,<1%,2%,5%,3%,1%,<1%,<1%,<1%,1%,5%,0%,0%,<1%,0%,0%,2%,<1%,<1%,<1%,<1%,2%,<1%,<1%,15%,<1%,<1%,<1%,<1%,<1%,<1%,25%,1%,<1%,<1%,2%,<1%,<1%,5%,<1%,<1%,<1%,<1%,<1%,<1%,<1%
English Bulldog,72%,15%,5%,10%,<1%,<1%,20%,5%,<1%,2%,<1%,4%,10%,<1%,1%,55%,10%,2%,45%,50%,25%,35%,<1%,<1%,<1%,1%,<1%,<1%,5%,<1%,<1%,<1%,<1%,<1%,5%,<1%,10%,<1%,<1%,3%,<1%,40%,<1%,15%,15%,<1%,20%,<1%,<1%,<1%
Dachshund,10%,10%,5%,24%,<1%,1%,2%,3%,<1%,15%,<1%,<1%,<1%,1%,1%,<1%,<1%,<1%,<1%,<1%,5%,<1%,1%,15%,<1%,5%,<1%,<1%,<1%,<1%,<1%,<1%,<1%,<1%,15%,<1%,2%,1%,<1%,1%,<1%,3%,15%,2%,<1%,<1%,10%,1%,<1%,2%
Afghan Hound,6%,2%,<1%,<1%,3%,<1%,<1%,<1%,<1%,2%,<1%,<1%,<1%,2%,1%,0%,0%,8%,0%,0%,5%,<1%,<1%,<1%,<1%,1%,1%,<1%,15%,<1%,<1%,<1%,<1%,<1%,<1%,2%,<1%,<1%,<1%,1%,<1%,<1%,3%,2%,<1%,<1%,<1%,<1%,<1%,<1%
Old English Sheepdog,19%,5%,<1%,<1%,2%,<1%,4%,5%,6%,2%,3%,2%,<1%,1%,3%,0%,0%,<1%,0%,0%,10%,<1%,3%,<1%,<1%,3%,10%,<1%,10%,<1%,<1%,<1%,<1%,3%,2%,1%,1%,<1%,<1%,2%,10%,<1%,5%,5%,<1%,<1%,2%,<1%,<1%,<1%
Shar-Pei,15%,12%,10%,2%,<1%,<1%,5%,<1%,3%,2%,<1%,<1%,<1%,<1%,2%,20%,<1%,<1%,15%,15%,30%,35%,2%,<1%,<1%,2%,<1%,<1%,5%,<1%,<1%,<1%,<1%,<1%,2%,<1%,15%,<1%,<1%,2%,<1%,5%,2%,40%,5%,<1%,5%,<1%,<1%,<1%`;

//    const CSV_RAW = `Breed,Hip Dysplasia,Elbow Dysplasia,Patellar Luxation,Intervertebral Disc Disease (IVDD),Panosteitis,Legg-Calvé-Perthes Disease,Cranial Cruciate Ligament (CCL) Rupture,Spondylosis Deformans,Osteochondritis Dissecans (OCD),Mitral Valve Disease,Dilated Cardiomyopathy (DCM),Subaortic Stenosis,Pulmonic Stenosis,Von Willebrand's Disease,Hemangiosarcoma,Brachycephalic Obstructive Airway Syndrome (BOAS),Tracheal Collapse,Laryngeal Paralysis,Elongated Soft Palate,Stenotic Nares,Atopic Dermatitis,Skin Fold Pyoderma,Sebaceous Adenitis,Color Dilution Alopecia,Ichthyosis,Idiopathic Epilepsy,Degenerative Myelopathy,Syringomyelia,Gastric Dilatation-Volvulus (GDV/Bloat),Exocrine Pancreatic Insufficiency (EPI),Copper Storage Hepatopathy,Portosystemic Shunt,Hyperlipidemia-induced Pancreatitis,Hypoadrenocorticism (Addison's Disease),Hyperadrenocorticism (Cushing's Disease),Osteosarcoma,Mast Cell Tumors,Transitional Cell Carcinoma (TCC),Histiocytic Sarcoma,Lymphoma,MDR1 Drug Sensitivity,Cherry Eye,Progressive Retinal Atrophy (PRA),Entropion,Ectropion,Collie Eye Anomaly,Keratoconjunctivitis Sicca (Dry Eye),Dermoid Sinus,Fanconi Syndrome,Narcolepsy
//Shire,<1%,<1%,<1%,<1%,0%,0%,0%,5%,15%,<1%,<1%,<1%,<1%,0%,0%,0%,0%,5%,0%,0%,15%,10%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%,5%,0%,<1%,0%,0%,1%,0%,0%,0%,1%,1%,0%,0%,0%,0%,0%
//Falabella,<1%,<1%,10%,<1%,0%,0%,0%,<1%,5%,<1%,<1%,<1%,<1%,0%,0%,0%,5%,<1%,0%,0%,<1%,0%,0%,0%,0%,1%,0%,0%,0%,0%,0%,0%,15%,0%,5%,0%,<1%,0%,0%,<1%,0%,0%,0%,0%,0%,0%,0%,0%,0%,<1%
//Akhal-Teke,<1%,<1%,<1%,<1%,0%,0%,0%,10%,8%,<1%,<1%,<1%,<1%,0%,0%,0%,0%,1%,0%,0%,<1%,0%,0%,0%,<1%,0%,5%,0%,0%,0%,0%,0%,0%,0%,<1%,0%,<1%,0%,0%,<1%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%
//Bashkir Curly,<1%,<1%,<1%,<1%,0%,0%,0%,<1%,5%,<1%,<1%,<1%,<1%,0%,0%,0%,0%,<1%,0%,0%,<1%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%,2%,0%,<1%,0%,0%,<1%,0%,0%,0%,0%,0%,0%,0%,0%,0%,0%`;

    // ── Parse CSV ──
    function parseCSV(raw) {
        const lines = raw.trim().split('\n');
        const headers = parseCSVLine(lines[0]);
        const maladies = headers.slice(1);
        const breeds = [];
        for (let i = 1; i < lines.length; i++) {
            const cols = parseCSVLine(lines[i]);
            const name = cols[0];
            const data = {};
            for (let j = 1; j < cols.length; j++) {
                data[maladies[j - 1]] = parsePct(cols[j]);
            }
            breeds.push({ name, data });
        }
        return { breeds, maladies };
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') { inQuotes = !inQuotes; }
            else if (ch === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
            else { current += ch; }
        }
        result.push(current.trim());
        return result;
    }

    function parsePct(s) {
        s = s.trim();
        if (s === '<1%') return 0.5;
        return parseFloat(s) || 0;
    }

    const { breeds: ALL_BREEDS, maladies: ALL_MALADIES } = parseCSV(CSV_RAW);

    // ── Image path helper ──
    function breedImagePath(breedName) {
        return 'images/' + breedName + '.png';
    }

    // ── Game state ──
    let round = 0;
    let totalScore = 0;
    let roundTimer = null;
    let roundStartTime = 0;
    let roundTimeLeft = 0;
    const ROUND_SECONDS = 30;
    const TOTAL_ROUNDS = 5;
    const MALADY_COUNT = 5;
    const MIN_DIFF = 5;
    let answeredThisRound = 0;
    let roundLog = []; // { round, malady, picked, correct, points, leftBreed, rightBreed }
    let usedPairs = [];

    // ── Shuffle helper ──
    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // ── Pick a breed pair with enough qualifying maladies ──
    function pickPair() {
        const indices = ALL_BREEDS.map((_, i) => i);
        shuffle(indices);
        for (let a = 0; a < indices.length; a++) {
            for (let b = a + 1; b < indices.length; b++) {
                const i = indices[a], j = indices[b];
                const key = Math.min(i, j) + '-' + Math.max(i, j);
                if (usedPairs.includes(key)) continue;
                const qualifying = getMaladiesForPair(ALL_BREEDS[i], ALL_BREEDS[j]);
                if (qualifying.length >= MALADY_COUNT) {
                    usedPairs.push(key);
                    return [ALL_BREEDS[i], ALL_BREEDS[j], qualifying];
                }
            }
        }
        // Fallback: allow repeats
        for (let a = 0; a < indices.length; a++) {
            for (let b = a + 1; b < indices.length; b++) {
                const i = indices[a], j = indices[b];
                const qualifying = getMaladiesForPair(ALL_BREEDS[i], ALL_BREEDS[j]);
                if (qualifying.length >= MALADY_COUNT) {
                    return [ALL_BREEDS[i], ALL_BREEDS[j], qualifying];
                }
            }
        }
        return null;
    }

    function getMaladiesForPair(breedA, breedB) {
        return ALL_MALADIES
            .map(m => {
                const diff = Math.abs(breedA.data[m] - breedB.data[m]);
                return { name: m, diff, aVal: breedA.data[m], bVal: breedB.data[m] };
            })
            .filter(m => m.diff >= MIN_DIFF)
            .sort((a, b) => b.diff - a.diff);
    }

    // ── Screens ──
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // ── Start ──
    function startGame() {
        round = 0;
        totalScore = 0;
        roundLog = [];
        usedPairs = [];
        document.getElementById('current-score').textContent = '0';
        showScreen('game-screen');
        nextRound();
    }

    // ── Round ──
    function nextRound() {
        round++;
        if (round > TOTAL_ROUNDS) { showResults(); return; }

        document.getElementById('next-round-btn').style.display = 'none';
        document.getElementById('round-num').textContent = round;
        answeredThisRound = 0;

        const pair = pickPair();
        if (!pair) { showResults(); return; }

        const [breedA, breedB, qualifying] = pair;

        // Randomly swap sides
        const swap = Math.random() < 0.5;
        const left = swap ? breedB : breedA;
        const right = swap ? breedA : breedB;

        document.getElementById('left-name').textContent = left.name;
        document.getElementById('right-name').textContent = right.name;
        document.getElementById('left-img').src = breedImagePath(left.name.replace(/\s/g, ''));
        document.getElementById('right-img').src = breedImagePath(right.name.replace(/\s/g, ''));

        // Store round context for drag-drop handlers
        currentLeft = left;
        currentRight = right;

        // Pick 5 maladies
        const selected = shuffle(qualifying.slice()).slice(0, MALADY_COUNT);
        currentMaladies = selected;

        // Clear drop zones
        const dropLeft = document.getElementById('drop-left');
        const dropRight = document.getElementById('drop-right');
        dropLeft.innerHTML = '<span class="drop-zone-label">Drop here</span>';
        dropRight.innerHTML = '<span class="drop-zone-label">Drop here</span>';

        const col = document.getElementById('maladies-column');
        col.innerHTML = '';

        selected.forEach((mal, idx) => {
            const card = document.createElement('div');
            card.className = 'malady-card';
            card.id = 'malady-card-' + idx;
            card.draggable = true;
            card.dataset.idx = idx;

            const handle = document.createElement('span');
            handle.className = 'drag-handle';
            handle.textContent = '⠿';

            const label = document.createElement('div');
            label.className = 'malady-name';
            label.textContent = mal.name;

            card.appendChild(handle);
            card.appendChild(label);
            col.appendChild(card);

            // Drag events
            card.addEventListener('dragstart', (e) => {
                if (card.classList.contains('answered')) { e.preventDefault(); return; }
                e.dataTransfer.setData('text/plain', idx);
                e.dataTransfer.effectAllowed = 'move';
                requestAnimationFrame(() => card.classList.add('dragging'));
            });
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
            });

            // Touch drag support
            card.addEventListener('touchstart', handleTouchStart, { passive: false });
            card.addEventListener('touchmove', handleTouchMove, { passive: false });
            card.addEventListener('touchend', handleTouchEnd, { passive: false });
        });

        // Setup drop zone listeners (once)
        if (!dropLeft.dataset.listening) {
            setupDropZone(dropLeft, 'left');
            dropLeft.dataset.listening = '1';
        }
        if (!dropRight.dataset.listening) {
            setupDropZone(dropRight, 'right');
            dropRight.dataset.listening = '1';
        }

        // Start timer
        startTimer();
    }

    let currentLeft = null;
    let currentRight = null;
    let currentMaladies = [];
    let touchDragIdx = null;
    let touchClone = null;

    function setupDropZone(zone, side) {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            zone.classList.add('drag-over');
        });
        zone.addEventListener('dragleave', () => {
            zone.classList.remove('drag-over');
        });
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            const idx = parseInt(e.dataTransfer.getData('text/plain'));
            if (isNaN(idx)) return;
            processDrop(idx, side);
        });
    }

    // ── Touch drag helpers ──
    function handleTouchStart(e) {
        const card = e.currentTarget;
        if (card.classList.contains('answered')) return;
        const idx = parseInt(card.dataset.idx);
        touchDragIdx = idx;

        // Create a visual clone that follows the finger
        touchClone = card.cloneNode(true);
        touchClone.style.position = 'fixed';
        touchClone.style.pointerEvents = 'none';
        touchClone.style.opacity = '0.8';
        touchClone.style.zIndex = '9999';
        touchClone.style.width = card.offsetWidth + 'px';
        const touch = e.touches[0];
        touchClone.style.left = (touch.clientX - card.offsetWidth / 2) + 'px';
        touchClone.style.top = (touch.clientY - 20) + 'px';
        document.body.appendChild(touchClone);

        card.classList.add('dragging');
        e.preventDefault();
    }

    function handleTouchMove(e) {
        if (touchClone === null) return;
        const touch = e.touches[0];
        touchClone.style.left = (touch.clientX - touchClone.offsetWidth / 2) + 'px';
        touchClone.style.top = (touch.clientY - 20) + 'px';

        // Highlight drop zones
        const dropLeft = document.getElementById('drop-left');
        const dropRight = document.getElementById('drop-right');
        highlightDropZone(dropLeft, touch);
        highlightDropZone(dropRight, touch);
        e.preventDefault();
    }

    function highlightDropZone(zone, touch) {
        const rect = zone.getBoundingClientRect();
        if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
            touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
            zone.classList.add('drag-over');
        } else {
            zone.classList.remove('drag-over');
        }
    }

    function handleTouchEnd(e) {
        const card = e.currentTarget;
        card.classList.remove('dragging');
        if (touchClone) {
            touchClone.remove();
            touchClone = null;
        }
        if (touchDragIdx === null) return;

        const touch = e.changedTouches[0];
        const dropLeft = document.getElementById('drop-left');
        const dropRight = document.getElementById('drop-right');
        dropLeft.classList.remove('drag-over');
        dropRight.classList.remove('drag-over');

        const rectL = dropLeft.getBoundingClientRect();
        const rectR = dropRight.getBoundingClientRect();
        if (touch.clientX >= rectL.left && touch.clientX <= rectL.right &&
            touch.clientY >= rectL.top && touch.clientY <= rectL.bottom) {
            processDrop(touchDragIdx, 'left');
        } else if (touch.clientX >= rectR.left && touch.clientX <= rectR.right &&
            touch.clientY >= rectR.top && touch.clientY <= rectR.bottom) {
            processDrop(touchDragIdx, 'right');
        }
        touchDragIdx = null;
        e.preventDefault();
    }

    function processDrop(idx, side) {
        const card = document.getElementById('malady-card-' + idx);
        if (!card || card.classList.contains('answered')) return;

        const mal = currentMaladies[idx];
        const left = currentLeft;
        const right = currentRight;

        card.classList.add('answered');
        answeredThisRound++;

        const leftVal = left.data[mal.name];
        const rightVal = right.data[mal.name];
        const correctSide = leftVal >= rightVal ? 'left' : 'right';
        const isCorrect = side === correctSide;

        // Time bonus
        const elapsed = (Date.now() - roundStartTime) / 1000;
        const timeFraction = Math.max(0, (ROUND_SECONDS - elapsed) / ROUND_SECONDS);
        const diffPoints = Math.round(mal.diff);
        const timeBonus = Math.round(diffPoints * timeFraction);
        const points = isCorrect ? diffPoints + timeBonus : 0;

        totalScore += points;
        document.getElementById('current-score').textContent = totalScore;

        // Move card from center into the drop zone as a landed card
        card.style.display = 'none';

        const dropZone = document.getElementById(side === 'left' ? 'drop-left' : 'drop-right');
        // Remove placeholder label if present
        const placeholder = dropZone.querySelector('.drop-zone-label');
        if (placeholder) placeholder.remove();

        const landed = document.createElement('div');
        landed.className = 'malady-landed ' + (isCorrect ? 'correct-answer' : 'wrong-answer');

        const nameEl = document.createElement('div');
        nameEl.className = 'malady-name';
        nameEl.textContent = mal.name;

        const detail = document.createElement('div');
        detail.className = 'malady-detail';
        detail.textContent = fmtPct(leftVal) + ' vs ' + fmtPct(rightVal);

        const ptsEl = document.createElement('div');
        ptsEl.className = 'points-popup ' + (isCorrect ? 'correct' : 'wrong');
        ptsEl.textContent = isCorrect ? '+' + points : '+0';

        landed.appendChild(nameEl);
        landed.appendChild(detail);
        landed.appendChild(ptsEl);
        dropZone.appendChild(landed);

        // Log
        roundLog.push({
            round,
            malady: mal.name,
            picked: side === 'left' ? left.name : right.name,
            correct: correctSide === 'left' ? left.name : right.name,
            isCorrect,
            points,
            leftBreed: left.name,
            rightBreed: right.name,
            leftVal,
            rightVal
        });

        if (answeredThisRound >= MALADY_COUNT) {
            clearInterval(roundTimer);
            document.getElementById('next-round-btn').style.display = '';
            document.getElementById('next-round-btn').textContent = round >= TOTAL_ROUNDS ? 'See Results' : 'Next Round';
        }
    }

    function fmtPct(v) {
        if (v === 0.5) return '<1%';
        if (v === 0) return '0%';
        return v + '%';
    }

    // ── Timer ──
    function startTimer() {
        roundStartTime = Date.now();
        roundTimeLeft = ROUND_SECONDS;
        document.getElementById('timer-display').textContent = ROUND_SECONDS;
        document.getElementById('timer-bar').style.width = '100%';

        clearInterval(roundTimer);
        roundTimer = setInterval(() => {
            const elapsed = (Date.now() - roundStartTime) / 1000;
            const remaining = Math.max(0, ROUND_SECONDS - elapsed);
            document.getElementById('timer-display').textContent = Math.ceil(remaining);
            document.getElementById('timer-bar').style.width = (remaining / ROUND_SECONDS * 100) + '%';

            if (remaining <= 0) {
                clearInterval(roundTimer);
                // Auto-skip unanswered maladies
                autoSkipRemaining();
            }
        }, 250);
    }

    function autoSkipRemaining() {
        document.querySelectorAll('.malady-card:not(.answered)').forEach(card => {
            card.classList.add('answered', 'wrong-answer');
            card.draggable = false;
        });
        if (answeredThisRound < MALADY_COUNT) {
            answeredThisRound = MALADY_COUNT;
        }
        document.getElementById('next-round-btn').style.display = '';
        document.getElementById('next-round-btn').textContent = round >= TOTAL_ROUNDS ? 'See Results' : 'Next Round';
    }

    // ── Results ──
    function showResults() {
        clearInterval(roundTimer);
        showScreen('results-screen');
        document.getElementById('final-score').textContent = totalScore;

        const tbody = document.getElementById('results-body');
        tbody.innerHTML = '';
        roundLog.forEach(entry => {
            const tr = document.createElement('tr');
            tr.className = entry.isCorrect ? 'correct-row' : 'wrong-row';
            tr.innerHTML =
                '<td class="result-icon">' + (entry.isCorrect ? '✅' : '❌') + '</td>' +
                '<td>' + entry.round + '</td>' +
                '<td>' + entry.malady + '</td>' +
                '<td>' + entry.picked + '</td>' +
                '<td>' + entry.correct + ' (' + fmtPct(entry.leftVal) + ' / ' + fmtPct(entry.rightVal) + ')</td>' +
                '<td>' + entry.points + '</td>';
            tbody.appendChild(tr);
        });
    }
</script>
</body>
</html>